<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Palette</title>
    <script>
        // åœ¨é¡µé¢åŠ è½½å‰åˆå§‹åŒ–ä¸»é¢˜
        (function() {
            const savedConfig = JSON.parse(localStorage.getItem('aiPaletteConfig') || '{}');
            if (savedConfig.theme) {
                document.documentElement.classList.toggle('dark', savedConfig.theme === 'dark');
            } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('dark');
            }
        })();
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {}
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer components {
            .gradient-bg {
                @apply dark:bg-gradient-to-br dark:from-slate-900 dark:to-slate-800 bg-gradient-to-br from-slate-50 to-slate-100;
            }
            .floating-image {
                @apply fixed left-8 top-8 w-[320px] rounded-lg shadow-lg transition-transform duration-300
                       hover:shadow-xl z-50;
                filter: drop-shadow(0 4px 12px rgba(0, 120, 255, 0.2));
            }
            .floating-image:hover {
                @apply -translate-y-1 rotate-1;
                filter: drop-shadow(0 8px 16px rgba(0, 120, 255, 0.3));
            }
            .github-corner:hover .octo-arm {
                animation: octocat-wave 560ms ease-in-out;
            }
            @keyframes octocat-wave {
                0%, 100% { transform: rotate(0) }
                20%, 60% { transform: rotate(-25deg) }
                40%, 80% { transform: rotate(10deg) }
            }
            .input-base {
                @apply w-full rounded-lg border shadow-sm backdrop-blur-sm px-4 py-3
                       dark:border-gray-700/50 dark:bg-gray-800/50 dark:text-gray-100
                       border-gray-200 bg-white/90 text-gray-900
                       dark:hover:border-blue-400/40 dark:hover:bg-gray-800/70
                       hover:border-blue-400/40 hover:bg-white
                       dark:focus:border-blue-400 dark:focus:bg-gray-800/90 dark:focus:ring-2 dark:focus:ring-blue-500/20
                       focus:border-blue-400 focus:bg-white focus:ring-2 focus:ring-blue-500/20 focus:outline-none
                       transition-all duration-200;
            }
            .btn-primary {
                @apply w-full bg-gradient-to-r from-blue-500 to-blue-600
                       text-white py-3 px-4 rounded-lg font-medium
                       hover:opacity-90 active:opacity-80
                       transform active:scale-[0.99]
                       transition-all duration-200
                       shadow-sm hover:shadow-blue-500/10 focus:shadow-md focus:outline-none;
            }
            .label-text {
                @apply block text-sm font-medium mb-1.5
                       dark:text-gray-300 text-gray-700;
            }
            .response-box {
                @apply w-full rounded-lg p-4 min-h-[100px] whitespace-pre-wrap backdrop-blur-sm shadow-sm
                       dark:bg-gray-800/50 dark:border dark:border-gray-700/50 dark:text-gray-100
                       bg-white/90 border border-gray-200 text-gray-900;
            }
            select {
                @apply input-base appearance-none bg-no-repeat cursor-pointer pr-10;
                background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
                background-position: right 0.75rem center;
                background-size: 1.5em 1.5em;
            }
            input[type="checkbox"] {
                @apply w-5 h-5 rounded-md cursor-pointer transition-colors duration-200
                       focus:ring-0 focus:ring-offset-0
                       dark:border-gray-700 dark:bg-gray-800 dark:text-blue-500
                       border-gray-300 bg-white text-blue-500;
            }
            ::placeholder {
                @apply dark:text-gray-500 text-gray-400;
            }
            option {
                @apply dark:bg-gray-800 dark:text-gray-100 bg-white text-gray-900;
            }
            .reasoning-content {
                @apply overflow-hidden transition-all duration-300 ease-in-out;
            }
            .reasoning-arrow {
                @apply transform transition-transform duration-300 ease-in-out;
            }
            .breathing-button {
                @apply animate-pulse;
                animation: breathing 2s ease-in-out infinite;
            }
            
            @keyframes breathing {
                0% {
                    box-shadow: 0 0 0 0 rgba(147, 51, 234, 0.7);
                }
                70% {
                    box-shadow: 0 0 0 10px rgba(147, 51, 234, 0);
                }
                100% {
                    box-shadow: 0 0 0 0 rgba(147, 51, 234, 0);
                }
            }

            .thinking-label {
                @apply px-2 py-0.5;
                animation: thinkingBreathing 2s ease-in-out infinite;
            }
            
            @keyframes thinkingBreathing {
                0% {
                    color: rgb(244, 114, 182);
                    text-shadow: 0 0 5px rgba(244, 114, 182, 0.5);
                }
                50% {
                    color: rgb(236, 72, 153);
                    text-shadow: 0 0 10px rgba(236, 72, 153, 0.7);
                }
                100% {
                    color: rgb(244, 114, 182);
                    text-shadow: 0 0 5px rgba(244, 114, 182, 0.5);
                }
            }

            .thinking-label.thinking-done {
                @apply text-slate-400;
                animation: none;
                text-shadow: none;
            }

            .thinking-text {
                @apply text-slate-400;
            }
        }
    </style>
</head>
<body class="dark:bg-slate-900 dark:text-slate-200 bg-slate-50 text-slate-900">
    <!-- æ¬¢è¿æ¨¡æ€æ¡† -->
    <div id="welcomeModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 opacity-0 pointer-events-none transition-opacity duration-300">
        <div class="relative bg-white dark:bg-slate-800 rounded-xl max-w-lg w-full mx-4 p-6 shadow-xl transform transition-transform duration-300 scale-95">
            <div class="absolute top-4 right-4">
                <button onclick="closeWelcomeModal()" class="dark:text-slate-400 text-slate-500 dark:hover:text-slate-300 hover:text-slate-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
                        <path d="M18 6l-12 12"></path>
                        <path d="M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="space-y-4">
                <h2 class="text-2xl font-bold dark:text-white text-slate-900">æ¬¢è¿ä½¿ç”¨ AI Palette! ğŸ¨</h2>
                <div class="space-y-2">
                    <p class="dark:text-slate-300 text-slate-600">AI Palette æ˜¯ä¸€ä¸ªç»Ÿä¸€çš„ AI æ¥å£å¹³å°ï¼Œæ”¯æŒå¤šç§å¹³å°ï¼š</p>
                    <ul class="list-disc pl-5 dark:text-slate-300 text-slate-600 space-y-1">
                        <li><span class="font-medium text-blue-500"><a href="https://cloud.siliconflow.cn/i/gQhQNfpv" target="_blank" class="text-blue-500 hover:text-blue-600">ç¡…åŸºæµåŠ¨</a></span> - æ¨èï¼æä¾›ä¸°å¯Œçš„æ¨¡å‹é€‰æ‹©ï¼Œå“åº”é€Ÿåº¦å¿«</li>
                        <li><span class="font-medium">Ollama</span> - æœ¬åœ°éƒ¨ç½²ï¼Œæ— éœ€ API Key</li>
                        <li><span class="font-medium">å…¶ä»–</span> - DeepSeekã€OpenAIã€æ™ºè°±ã€åƒé—®ç­‰ã€‚</li>
                    </ul>
                </div>
                <div class="bg-slate-50 dark:bg-slate-700/50 rounded-lg p-4 space-y-2">
                    <p class="dark:text-slate-300 text-slate-600 font-medium">å¿«é€Ÿå¼€å§‹ï¼š</p>
                    <p class="dark:text-slate-400 text-slate-600">1. é€‰æ‹©å¹³å°ï¼ˆæ¨èä½¿ç”¨ç¡…åŸºæµåŠ¨ï¼Œå…è´¹ç”¨Qwen2.5ï¼‰</p>
                    <p class="dark:text-slate-400 text-slate-600">2. è¾“å…¥ API Keyï¼ˆ<a href="https://cloud.siliconflow.cn/i/gQhQNfpv" target="_blank" class="text-blue-500 hover:text-blue-600">ç‚¹å‡»è·å–</a>ï¼‰</p>
                    <p class="dark:text-slate-400 text-slate-600">3. å¼€å§‹å¯¹è¯ï¼</p>
                </div>
                <div class="bg-slate-50 dark:bg-slate-700/50 rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div class="dark:text-slate-300 text-slate-600">
                            <p class="font-medium">æœ‰ä»»ä½•æƒ³æ³•ï¼Ÿ</p>
                            <p class="text-sm mt-1">æ‰«æäºŒç»´ç å…³æ³¨æˆ‘ä»¬ï¼Œè·å–å¸®åŠ©å’Œæ›´æ–°ï¼</p>
                        </div>
                        <img src="/static/image/qrcode.jpg" alt="Connect" class="w-24 h-24 rounded-lg dark:border-slate-600 border-slate-200 border">
                    </div>
                </div>
                <div class="flex justify-end pt-2">
                    <button onclick="closeWelcomeModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-slate-800 focus:ring-offset-white">
                        å¼€å§‹ä½¿ç”¨
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸»å®¹å™¨ -->
    <div class="flex h-screen">
        <!-- å·¦ä¾§è®¾ç½®é¢æ¿ -->
        <div class="w-80 border-r dark:border-slate-700 border-slate-200 dark:bg-slate-800 bg-white p-6 flex flex-col">
            <div class="mb-6">
                <div class="flex items-center justify-between mb-2">
                    <h1 class="text-2xl font-bold dark:text-white text-slate-800">AI Palette ğŸ¨</h1>
                    <div class="flex">
                        <div class="rounded-md border dark:border-slate-200/20 border-slate-200">
                            <div class="flex text-[10px] font-medium leading-4">
                                <button onclick="toggleTheme('dark')" class="theme-toggle dark-toggle flex w-auto gap-1 rounded-l-md px-2 py-1 focus:outline-none dark:text-slate-300 text-slate-500 dark:hover:bg-slate-700/50 hover:bg-slate-100">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="inline-flex h-3.5 w-3.5">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                                    </svg>
                                </button>
                                <button onclick="toggleTheme('light')" class="theme-toggle light-toggle flex gap-1 rounded-r-md px-2 py-1 focus:outline-none dark:text-slate-300 text-slate-500 dark:hover:bg-slate-700/50 hover:bg-slate-100">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" class="inline-flex h-3.5 w-3.5" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <p class="dark:text-slate-400 text-slate-600 text-sm">ç»Ÿä¸€ AI æ¥å£ï¼Œä¸€ä¸ªè°ƒç”¨æ»¡è¶³æ‰€æœ‰éœ€æ±‚</p>
            </div>

            <!-- æ¨¡å‹è®¾ç½® -->
            <div class="space-y-4 flex-1">
                <div>
                    <label class="block text-sm font-medium dark:text-slate-300 text-slate-600 mb-1">æ¨¡å‹æä¾›å•†</label>
                    <select id="modelType" onchange="handleModelTypeChange()" class="input-base">
                        <option value="siliconflow">ç¡…åŸºæµåŠ¨</option>
                        <option value="deepseek">DeepSeek</option>
                        <option value="ollama">Ollama</option>
                        <option value="openai">OpenAI</option>
                        <option value="zhipu">æ™ºè°±AI</option>
                        <option value="dashscope">é€šä¹‰åƒé—®</option>
                        <option value="minimax">MiniMax</option>
                        <option value="ernie">ç™¾åº¦æ–‡å¿ƒ</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium dark:text-slate-300 text-slate-600 mb-1">API Key</label>
                    <div class="relative">
                        <input type="password" id="apiKey" class="input-base" 
                            placeholder="è¾“å…¥ä½ çš„ API Key"
                            onblur="handleApiKeyChange()">
                        <button onclick="toggleApiKeyVisibility()" class="absolute right-2 top-1/2 -translate-y-1/2 dark:text-slate-400 text-slate-500 dark:hover:text-slate-300 hover:text-slate-700">
                            <svg id="eyeIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
                                <path d="M12 12m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0"></path>
                                <path d="M22 12c-2.667 4.667 -6 7 -10 7s-7.333 -2.333 -10 -7c2.667 -4.667 6 -7 10 -7s7.333 2.333 10 7"></path>
                            </svg>
                        </button>
                    </div>
                    <a id="apiKeyHelp" href="#" target="_blank" class="text-sm text-blue-500 hover:text-blue-600 mt-1 inline-block">
                        è·³è½¬å®˜ç½‘è·å– API Key
                    </a>
                </div>

                <div>
                    <label class="block text-sm font-medium dark:text-slate-300 text-slate-600 mb-1">æ¨¡å‹åç§°</label>
                    <div class="relative">
                        <input 
                            type="text" 
                            id="model" 
                            class="input-base pr-20" 
                            placeholder="é€‰æ‹©æˆ–è¾“å…¥æ¨¡å‹åç§°"
                            oninput="filterModels(this.value)"
                            onclick="showModelDropdown()"
                            autocomplete="off"
                        >
                        <button 
                            onclick="refreshModels()"
                            type="button"
                            class="absolute right-2 top-1/2 -translate-y-1/2 dark:text-slate-400 text-slate-500 dark:hover:text-slate-300 hover:text-slate-700"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
                                <path d="M20 11a8.1 8.1 0 0 0 -15.5 -2m-.5 -4v4h4"></path>
                                <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
                            </svg>
                        </button>
                        <!-- æ¨¡å‹åˆ—è¡¨ä¸‹æ‹‰æ¡† -->
                        <div id="modelDropdown" class="hidden absolute left-0 right-0 z-50 mt-1 max-h-60 overflow-auto rounded-lg dark:bg-slate-700 bg-white dark:border-slate-600 border-slate-200 border shadow-lg">
                            <div id="modelList" class="py-1">
                                <!-- æ¨¡å‹é€‰é¡¹å°†é€šè¿‡ JavaScript åŠ¨æ€æ·»åŠ  -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex items-center space-x-3">
                    <input type="checkbox" id="enableStreaming" class="rounded dark:border-slate-600 border-slate-300">
                    <label class="text-sm font-medium dark:text-slate-300 text-slate-600">å¯ç”¨æµå¼è¾“å‡º</label>
                </div>
            </div>

            <!-- åº•éƒ¨é“¾æ¥ -->
            <div class="mt-auto space-y-4">
                <!-- æ¸…é™¤å¯¹è¯å†å² -->
                <div>
                    <button onclick="clearAllMessages()" class="w-full flex items-center justify-center space-x-2 px-4 py-3 rounded-lg bg-red-500/10 dark:text-red-400 text-red-600 hover:bg-red-500/20 dark:hover:bg-red-500/20 transition-colors duration-200 border dark:border-red-900/50 border-red-200">
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                        <span class="text-base">æ¸…ç©ºå¯¹è¯å†å²</span>
                    </button>
                </div>

                <!-- GitHub é“¾æ¥ -->
                <div class="text-center">
                    <a href="https://github.com/itshen/ai_palette" class="inline-flex items-center gap-2 text-sm font-medium dark:text-slate-200 text-slate-600 hover:text-blue-500 transition-colors duration-200" target="_blank">
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                            <path fill-rule="evenodd" clip-rule="evenodd" d="M12 2C6.477 2 2 6.477 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33.85 0 1.71.11 2.5.33 1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0012 2z"/>
                        </svg>
                        GitHub ä»“åº“
                    </a>
                </div>
                <!-- äºŒç»´ç  -->
                <div>
                    <img src="/static/image/connect.jpg" alt="Connect" class="w-full rounded-lg dark:border-slate-600 border-slate-200 border">
                </div>
            </div>
        </div>

        <!-- å³ä¾§å¯¹è¯ç•Œé¢ -->
        <div class="flex-1 flex flex-col">
            <!-- æ¶ˆæ¯åˆ—è¡¨ -->
            <div class="flex-1 overflow-y-auto p-4" id="messageList">
                <!-- å¯¹è¯å»ºè®® -->
                <div id="suggestionBox" class="mb-4">
                    <div class="flex flex-wrap gap-2 text-xs">
                        <button onclick="usePromptAndSend(this)" class="rounded-lg dark:bg-slate-800 bg-white px-3 py-1.5 dark:hover:bg-blue-600 hover:bg-blue-50 dark:hover:text-slate-200 hover:text-blue-600 dark:text-slate-300 text-slate-600 dark:border-slate-700 border-slate-200 border">
                            å¸®æˆ‘åˆ¶å®šä¸€ä»½ä¸€å‘¨å¥åº·é¥®é£Ÿè®¡åˆ’
                        </button>
                        <button onclick="usePromptAndSend(this)" class="rounded-lg dark:bg-slate-800 bg-white px-3 py-1.5 dark:hover:bg-blue-600 hover:bg-blue-50 dark:hover:text-slate-200 hover:text-blue-600 dark:text-slate-300 text-slate-600 dark:border-slate-700 border-slate-200 border">
                            å¦‚ä½•ç¼“è§£å·¥ä½œå‹åŠ›å’Œæƒ…ç»ª
                        </button>
                        <button onclick="usePromptAndSend(this)" class="rounded-lg dark:bg-slate-800 bg-white px-3 py-1.5 dark:hover:bg-blue-600 hover:bg-blue-50 dark:hover:text-slate-200 hover:text-blue-600 dark:text-slate-300 text-slate-600 dark:border-slate-700 border-slate-200 border">
                            æ¨èä¸€äº›å®¤å†…æ¤ç‰©å…»æŠ¤å°æŠ€å·§
                        </button>
                        <button onclick="usePromptAndSend(this)" class="rounded-lg dark:bg-slate-800 bg-white px-3 py-1.5 dark:hover:bg-blue-600 hover:bg-blue-50 dark:hover:text-slate-200 hover:text-blue-600 dark:text-slate-300 text-slate-600 dark:border-slate-700 border-slate-200 border">
                            åˆ†äº«ä¸€äº›æé«˜ç¡çœ è´¨é‡çš„æ–¹æ³•
                        </button>
                        <button onclick="usePromptAndSend(this)" class="rounded-lg dark:bg-slate-800 bg-white px-3 py-1.5 dark:hover:bg-blue-600 hover:bg-blue-50 dark:hover:text-slate-200 hover:text-blue-600 dark:text-slate-300 text-slate-600 dark:border-slate-700 border-slate-200 border">
                            æ¨èå‡ é“ç®€å•ç¾å‘³çš„å®¶å¸¸èœ
                        </button>
                        <button onclick="usePromptAndSend(this)" class="rounded-lg dark:bg-slate-800 bg-white px-3 py-1.5 dark:hover:bg-blue-600 hover:bg-blue-50 dark:hover:text-slate-200 hover:text-blue-600 dark:text-slate-300 text-slate-600 dark:border-slate-700 border-slate-200 border">
                            å¦‚ä½•æ•´ç†å’Œæ”¶çº³å°æˆ·å‹ç©ºé—´
                        </button>
                        <button onclick="usePromptAndSend(this)" class="rounded-lg dark:bg-slate-800 bg-white px-3 py-1.5 dark:hover:bg-blue-600 hover:bg-blue-50 dark:hover:text-slate-200 hover:text-blue-600 dark:text-slate-300 text-slate-600 dark:border-slate-700 border-slate-200 border">
                            åˆ†äº«ä¸€äº›çœé’±å°å¦™æ‹›
                        </button>
                    </div>
                </div>
            </div>

            <!-- è¾“å…¥æ¡† -->
            <div class="p-4 border-t dark:border-slate-700 border-slate-200">
                <form onsubmit="sendMessage(); return false;">
                    <div class="relative">
                        <textarea 
                            id="prompt" 
                            class="input-base pr-24 resize-none"
                            rows="3"
                            placeholder="è¾“å…¥ä½ æƒ³é—®çš„é—®é¢˜..."
                        ></textarea>
                        <button 
                            type="submit"
                            class="absolute bottom-3 right-3 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-slate-800 focus:ring-offset-white"
                        >
                            å‘é€
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // åœ¨ç°æœ‰çš„ window.onload å‡½æ•°å¼€å¤´æ·»åŠ 
        window.onload = function() {
            // æ£€æŸ¥æ˜¯å¦æ˜¯é¦–æ¬¡è®¿é—®
            const hasVisited = localStorage.getItem('hasVisitedAIPalette');
            if (!hasVisited) {
                showWelcomeModal();
                localStorage.setItem('hasVisitedAIPalette', 'true');
            }

            // æ¢å¤èŠå¤©è®°å½•
            restoreChatHistory();

            // æ£€æµ‹ç³»ç»Ÿä¸»é¢˜å¹¶è®¾ç½®åˆå§‹çŠ¶æ€
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) {
                document.documentElement.classList.remove('dark');
                updateThemeButtons('light');
            } else {
                updateThemeButtons('dark');
            }

            // ç›‘å¬ç³»ç»Ÿä¸»é¢˜å˜åŒ–
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                if (event.matches) {
                    document.documentElement.classList.add('dark');
                    updateThemeButtons('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                    updateThemeButtons('light');
                }
            });

            // åŠ è½½å·²ä¿å­˜çš„é…ç½®
            const savedConfig = JSON.parse(localStorage.getItem('aiPaletteConfig') || '{}');
            if (savedConfig.modelType) {
                document.getElementById('modelType').value = savedConfig.modelType;
            }
            if (savedConfig.apiKey) {
                document.getElementById('apiKey').value = savedConfig.apiKey;
            }
            if (savedConfig.model) {
                document.getElementById('model').value = savedConfig.model;
            }
            if (savedConfig.hasOwnProperty('enableStreaming')) {
                document.getElementById('enableStreaming').checked = savedConfig.enableStreaming;
            }
            if (savedConfig.theme) {
                toggleTheme(savedConfig.theme);
            }

            // ç¡®ä¿åœ¨é¡µé¢åŠ è½½æ—¶æ›´æ–° API Key å¸®åŠ©é“¾æ¥
            updateApiKeyHelpLink();
            
            // åˆå§‹åŒ–ååˆ·æ–°æ¨¡å‹åˆ—è¡¨
            handleModelTypeChange();
        };

        // æ˜¾ç¤ºæ¬¢è¿æ¨¡æ€æ¡†
        function showWelcomeModal() {
            const modal = document.getElementById('welcomeModal');
            modal.style.opacity = '1';
            modal.style.pointerEvents = 'auto';
            const modalContent = modal.querySelector('.scale-95');
            setTimeout(() => {
                modalContent.classList.remove('scale-95');
                modalContent.classList.add('scale-100');
            }, 10);
        }

        // å…³é—­æ¬¢è¿æ¨¡æ€æ¡†
        function closeWelcomeModal() {
            const modal = document.getElementById('welcomeModal');
            const modalContent = modal.querySelector('.scale-100, .scale-95');
            if (modalContent) {
                modalContent.classList.remove('scale-100');
                modalContent.classList.add('scale-95');
            }
            setTimeout(() => {
                modal.style.opacity = '0';
                modal.style.pointerEvents = 'none';
            }, 200);
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
        document.getElementById('welcomeModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeWelcomeModal();
            }
        });

        // æ¨¡å‹é…ç½®
        const modelConfigs = {
            'openai': ['gpt-4o-mini', 'gpt-4o', 'gpt-3.5-turbo'],
            'ernie': ['ernie-bot', 'ernie-bot-4'],
            'dashscope': ['qwen-turbo', 'qwen-plus', 'qwen-max'],
            'zhipu': ['GLM-4-Plus', 'GLM-4-Flash'],
            'minimax': ['abab6.5-chat', 'abab7-preview'],
            'ollama': [],
            'deepseek': ['deepseek-coder', 'deepseek-chat'],
            'siliconflow': ['deepseek-ai/DeepSeek-R1', 'Qwen/Qwen2.5-7B-Instruct']
        };

        // å­˜å‚¨æ‰€æœ‰æ¨¡å‹åˆ—è¡¨
        let allModels = [];
        
        // åˆ·æ–°æ¨¡å‹åˆ—è¡¨
        async function refreshModels() {
            const modelType = document.getElementById('modelType').value;
            const apiKey = document.getElementById('apiKey').value;
            const modelList = document.getElementById('modelList');
            const modelInput = document.getElementById('model');
            
            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                modelInput.placeholder = 'åŠ è½½ä¸­...';
                modelInput.disabled = true;
                
                const response = await fetch(`/api/models?type=${modelType}&api_key=${apiKey}`);
                const data = await response.json();
                
                if (data.success) {
                    allModels = data.models || [];
                    updateModelList(allModels);
                    // å¦‚æœæœ‰æ¨¡å‹ï¼Œæ˜¾ç¤ºä¸‹æ‹‰æ¡†
                    if (allModels.length > 0) {
                        document.getElementById('modelDropdown').classList.remove('hidden');
                        modelInput.placeholder = 'é€‰æ‹©æˆ–è¾“å…¥æ¨¡å‹åç§°';
                    } else {
                        modelInput.placeholder = 'æœªæ‰¾åˆ°å¯ç”¨æ¨¡å‹';
                    }
                } else {
                    showError(data.error || 'è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥');
                    modelInput.placeholder = 'è·å–æ¨¡å‹å¤±è´¥';
                    allModels = [];
                }
            } catch (error) {
                showError('è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥: ' + error.message);
                modelInput.placeholder = 'è·å–æ¨¡å‹å¤±è´¥';
                allModels = [];
            } finally {
                modelInput.disabled = false;
            }
        }
        
        // ä¿®æ”¹è¿‡æ»¤æ¨¡å‹åˆ—è¡¨å‡½æ•°
        function filterModels(query) {
            const dropdown = document.getElementById('modelDropdown');
            const filteredModels = allModels.filter(model => 
                model.toLowerCase().includes(query.toLowerCase())
            );
            updateModelList(filteredModels);
            if (filteredModels.length > 0) {
                dropdown.classList.remove('hidden');
            }
        }
        
        // ä¿®æ”¹æ˜¾ç¤ºæ¨¡å‹ä¸‹æ‹‰åˆ—è¡¨å‡½æ•°
        function showModelDropdown() {
            const dropdown = document.getElementById('modelDropdown');
            
            // å¦‚æœè¿˜æ²¡æœ‰æ¨¡å‹åˆ—è¡¨æ•°æ®ï¼Œå…ˆè·å–
            if (allModels.length === 0) {
                refreshModels();
            } else {
                // æ˜¾ç¤ºæ‰€æœ‰æ¨¡å‹
                updateModelList(allModels);
                dropdown.classList.remove('hidden');
            }
        }
        
        // æ›´æ–°æ¨¡å‹åˆ—è¡¨æ˜¾ç¤º
        function updateModelList(models) {
            const modelList = document.getElementById('modelList');
            modelList.innerHTML = '';
            
            if (models.length === 0) {
                const noModels = document.createElement('div');
                noModels.className = 'px-4 py-2 dark:text-slate-400 text-slate-500 text-center';
                noModels.textContent = 'æ²¡æœ‰å¯ç”¨çš„æ¨¡å‹';
                modelList.appendChild(noModels);
                return;
            }
            
            models.forEach(model => {
                const option = document.createElement('div');
                option.className = 'px-4 py-2 dark:hover:bg-slate-600 hover:bg-slate-100 cursor-pointer dark:text-slate-200 text-slate-700';
                option.textContent = model;
                option.onclick = () => {
                    document.getElementById('model').value = model;
                    document.getElementById('modelDropdown').classList.add('hidden');
                    
                    // ä¿å­˜é€‰æ‹©
                    const modelType = document.getElementById('modelType').value;
                    const config = JSON.parse(localStorage.getItem('aiPaletteConfig') || '{}');
                    config[`${modelType}_lastModel`] = model;
                    localStorage.setItem('aiPaletteConfig', JSON.stringify(config));
                };
                modelList.appendChild(option);
            });
        }
        
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            // åˆ›å»ºé”™è¯¯æç¤º
            const errorDiv = document.createElement('div');
            errorDiv.className = 'fixed top-4 right-4 flex w-full max-w-md items-start justify-between rounded-xl dark:bg-slate-800 bg-white p-4 shadow-xl border dark:border-slate-700 border-slate-200';
            errorDiv.innerHTML = `
                <div class="flex gap-2 sm:gap-4">
                    <span class="text-red-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
                            <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0"></path>
                            <path d="M12 9v4"></path>
                            <path d="M12 16v.01"></path>
                        </svg>
                    </span>
                    <div class="flex-1">
                        <strong class="block font-medium dark:text-slate-200 text-slate-900">é”™è¯¯</strong>
                        <p class="mt-1 text-sm dark:text-slate-300 text-slate-600">${message}</p>
                    </div>
                </div>
                <button onclick="this.parentElement.remove()" class="dark:text-slate-400 text-slate-500 dark:hover:text-slate-300 hover:text-slate-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
                        <path d="M18 6l-12 12"></path>
                        <path d="M6 6l12 12"></path>
                    </svg>
                </button>
            `;
            document.body.appendChild(errorDiv);
            
            // æ·»åŠ è¿›å…¥åŠ¨ç”»
            errorDiv.style.opacity = '0';
            errorDiv.style.transform = 'translateY(-20px)';
            errorDiv.style.transition = 'all 0.3s ease-out';
            
            // å¼ºåˆ¶é‡ç»˜
            errorDiv.offsetHeight;
            
            // æ˜¾ç¤º
            errorDiv.style.opacity = '1';
            errorDiv.style.transform = 'translateY(0)';
            
            // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                errorDiv.style.opacity = '0';
                errorDiv.style.transform = 'translateY(-20px)';
                setTimeout(() => errorDiv.remove(), 300);
            }, 3000);
        }
        
        // ä¿®æ”¹å¤„ç†æ¨¡å‹ç±»å‹å˜åŒ–çš„å‡½æ•°
        async function handleModelTypeChange() {
            const modelType = document.getElementById('modelType').value;
            const apiKeyInput = document.getElementById('apiKey');
            const modelInput = document.getElementById('model');
            
            // æ›´æ–°å¸®åŠ©é“¾æ¥
            updateApiKeyHelpLink();
            
            // ä»æœ¬åœ°å­˜å‚¨è·å–è¯¥æ¨¡å‹ç±»å‹çš„ä¸Šæ¬¡é…ç½®
            const savedConfig = JSON.parse(localStorage.getItem('aiPaletteConfig') || '{}');
            
            // æ¢å¤ä¸Šæ¬¡ä½¿ç”¨çš„ API Key
            apiKeyInput.value = savedConfig[`${modelType}_apiKey`] || '';
            
            // æ¢å¤ä¸Šæ¬¡ä½¿ç”¨çš„æ¨¡å‹
            modelInput.value = savedConfig[`${modelType}_lastModel`] || '';
            
            // æ¸…ç©ºå½“å‰æ¨¡å‹åˆ—è¡¨
            allModels = [];
            document.getElementById('modelDropdown').classList.add('hidden');
            
            // è‡ªåŠ¨åˆ·æ–°æ¨¡å‹åˆ—è¡¨
            refreshModels();
        }

        // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹æ—¶éšè—ä¸‹æ‹‰æ¡†
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('modelDropdown');
            const modelInput = document.getElementById('model');
            const refreshButton = modelInput.nextElementSibling;
            
            if (!modelInput.contains(e.target) && !refreshButton.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.classList.add('hidden');
            }
        });

        // ç›‘å¬æ¨¡å‹è¾“å…¥æ¡†ç‚¹å‡»äº‹ä»¶
        document.getElementById('model').addEventListener('click', function() {
            if (allModels.length > 0) {
                filterModels(this.value);
            }
        });

        // ä¿å­˜é…ç½®
        function saveConfig() {
            const modelType = document.getElementById('modelType').value;
            const currentModel = document.getElementById('model').value;
            const currentApiKey = document.getElementById('apiKey').value;
            const enableStreaming = document.getElementById('enableStreaming').checked;
            
            const config = JSON.parse(localStorage.getItem('aiPaletteConfig') || '{}');
            
            config.modelType = modelType;
            config[`${modelType}_apiKey`] = currentApiKey;
            config[`${modelType}_lastModel`] = currentModel;
            config.enableStreaming = enableStreaming;
            
            localStorage.setItem('aiPaletteConfig', JSON.stringify(config));
        }

        // åˆ‡æ¢ API Key æ˜¾ç¤º/éšè—
        function toggleApiKeyVisibility() {
            const apiKeyInput = document.getElementById('apiKey');
            apiKeyInput.type = apiKeyInput.type === 'password' ? 'text' : 'password';
        }

        // æ›´æ–° API Key å¸®åŠ©é“¾æ¥
        function updateApiKeyHelpLink() {
            const modelType = document.getElementById('modelType').value || 'siliconflow';  // æ·»åŠ é»˜è®¤å€¼
            const helpLink = document.getElementById('apiKeyHelp');
            
            const helpLinks = {
                'openai': 'https://platform.openai.com/api-keys',
                'ernie': 'https://console.bce.baidu.com/qianfan/overview',
                'dashscope': 'https://bailian.console.aliyun.com/?apiKey=1',
                'zhipu': 'https://open.bigmodel.cn/usercenter/apikeys',
                'minimax': 'https://platform.minimaxi.com/user-center/basic-information/interface-key',
                'ollama': 'https://ollama.com',
                'deepseek': 'https://platform.deepseek.com/',
                'siliconflow': 'https://cloud.siliconflow.cn/i/gQhQNfpv'
            };
            
            helpLink.href = helpLinks[modelType] || helpLinks['siliconflow'];  // æ·»åŠ é»˜è®¤å€¼
            helpLink.style.display = (modelType === 'ollama') ? 'none' : 'inline-block';
        }

        // æ·»åŠ è½¬ä¹‰ HTML çš„å‡½æ•°
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ç®€å•çš„markdownè§£æ
        function parseMarkdown(text) {
            if (!text) return '';
            
            // å¤„ç†åŠ ç²— **text**
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // å¤„ç†æ ‡é¢˜ ### text
            text = text.replace(/^###### (.*?)$/gm, '<h6 class="text-sm font-bold my-3">$1</h6>');
            text = text.replace(/^##### (.*?)$/gm, '<h5 class="text-base font-bold my-3">$1</h5>');
            text = text.replace(/^#### (.*?)$/gm, '<h4 class="text-lg font-bold my-3">$1</h4>');
            text = text.replace(/^### (.*?)$/gm, '<h3 class="text-xl font-bold my-3">$1</h3>');
            text = text.replace(/^## (.*?)$/gm, '<h2 class="text-2xl font-bold my-3">$1</h2>');
            text = text.replace(/^# (.*?)$/gm, '<h1 class="text-3xl font-bold my-4">$1</h1>');
            
            // å¤„ç†åˆ—è¡¨ - text
            text = text.replace(/^- (.*?)$/gm, '<li class="ml-4">$1</li>');
            
            // å¤„ç†åˆ†éš”çº¿ ---
            text = text.replace(/^---$/gm, '<hr class="my-4 border-t dark:border-slate-700 border-slate-200">');
            
            // å¤„ç†æ¢è¡Œï¼Œä¿æŒåŸæœ‰çš„æ¢è¡Œ
            text = text.split('\n').map(line => {
                if (!line.startsWith('<') && line.trim() !== '') {
                    return `<p class="mb-1">${line}</p>`;
                }
                return line;
            }).join('\n');
            
            return text;
        }

        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const messageList = document.getElementById('messageList');
            const prompt = document.getElementById('prompt').value;
            const modelType = document.getElementById('modelType').value;
            const apiKey = document.getElementById('apiKey').value;
            const model = document.getElementById('model').value;
            const enableStreaming = document.getElementById('enableStreaming').checked;

            if (!prompt) return;

            // éšè—å»ºè®®æ¡†
            const suggestionBox = document.getElementById('suggestionBox');
            if (suggestionBox) {
                suggestionBox.remove();  // å®Œå…¨ç§»é™¤å»ºè®®æ¡†
            }

            // æ¸…é™¤å…¨å±€å˜é‡
            window.currentResponse = '';
            window.currentReasoning = '';
            window.isThinking = false;

            // ä¿å­˜é…ç½®
            saveConfig();

            // æ”¶é›†ä¸Šä¸‹æ–‡
            let context = [];
            // å¦‚æœæ˜¯é‡æ–°å‘èµ·çš„å¯¹è¯ï¼Œä½¿ç”¨ä¿å­˜çš„ä¸Šä¸‹æ–‡
            if (window.reaskContext) {
                context = window.reaskContext;
                window.reaskContext = null;  // ä½¿ç”¨åæ¸…é™¤
            } else {
                // æ­£å¸¸æ”¶é›†ä¸Šä¸‹æ–‡
                const messages = messageList.children;
                for (const message of messages) {
                    if (message.querySelector('.bg-blue-600')) {  // ç”¨æˆ·æ¶ˆæ¯
                        const pElement = message.querySelector('p');
                        context.push({
                            role: 'user',
                            content: pElement.dataset.originalContent || pElement.textContent.replace(/<br\s*\/?>/g, '\n')
                        });
                    } else if (message.querySelector('.bg-purple-600')) {  // AI æ¶ˆæ¯
                        const responseElement = message.querySelector('pre');
                        if (responseElement && responseElement.textContent && responseElement.textContent !== '...') {
                            context.push({
                                role: 'assistant',
                                content: responseElement.dataset.originalContent || responseElement.textContent.replace(/<br\s*\/?>/g, '\n')
                            });
                        }
                    }
                }
            }

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            const userMessage = document.createElement('div');
            userMessage.className = 'flex items-start space-x-3 mb-4';
            // å°†æ¢è¡Œç¬¦è½¬æ¢ä¸º <br/>
            const displayContent = prompt.replace(/\n/g, '<br/>');
            userMessage.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center flex-shrink-0 text-white">U</div>
                <div class="flex-1 dark:bg-slate-800 bg-white rounded-lg p-4 dark:border-slate-700 border-slate-200 border">
                    <p class="dark:text-slate-200 text-slate-700">${displayContent}</p>
                </div>
            `;
            // ä¿å­˜ç”¨æˆ·æ¶ˆæ¯åˆ°èŠå¤©è®°å½•
            const messages = JSON.parse(localStorage.getItem('aiPaletteChatHistory') || '[]');
            messages.push({
                type: 'user',
                content: prompt  // ä¿å­˜åŸå§‹å†…å®¹ï¼ŒåŒ…å« \n
            });
            localStorage.setItem('aiPaletteChatHistory', JSON.stringify(messages));

            messageList.appendChild(userMessage);

            // æ·»åŠ  AI å›å¤å®¹å™¨
            const aiMessage = addAIMessage(prompt);
            messageList.appendChild(aiMessage);

            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('prompt').value = '';

            // å‘é€è¯·æ±‚
            try {
                if (enableStreaming) {
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            model_type: modelType,
                            api_key: apiKey,
                            model: model,
                            prompt: prompt,
                            enable_streaming: true,
                            include_reasoning: true,
                            context: context
                        })
                    });

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    const responseElement = aiMessage.querySelector('pre');
                    const reasoningElement = aiMessage.querySelector('div[id^="ai-reasoning"]');
                    responseElement.textContent = '';
                    window.currentResponse = '';  // æ¸…é™¤ç¼“å­˜

                    while (true) {
                        const {value, done} = await reader.read();
                        if (done) {
                            // ç§»é™¤å‘¼å¸ç¯æ•ˆæœ
                            document.querySelector('button[type="submit"]').classList.remove('breathing-button');
                            saveChatHistory();
                            break;
                        }

                        const text = decoder.decode(value);
                        const lines = text.split('\n');

                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                try {
                                    const data = JSON.parse(line.slice(6));
                                    
                                    // å¤„ç†ä¸åŒç±»å‹çš„æ¶ˆæ¯
                                    if (data.type === 'reasoning') {
                                        // å¦‚æœè¿˜æ²¡æœ‰æ€è€ƒå®¹å™¨,åˆ›å»ºä¸€ä¸ª
                                        if (!reasoningElement.querySelector('.reasoning-content')) {
                                            reasoningElement.innerHTML = `
                                                <div class="text-slate-400">
                                                    <div class="flex items-center cursor-pointer hover:text-slate-300 transition-colors duration-200" onclick="toggleReasoning(this)">
                                                        <svg class="w-4 h-4 mr-1 reasoning-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="transform: rotate(90deg)">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                                        </svg>
                                                        <span class="thinking-label">æ€è€ƒè¿‡ç¨‹</span>
                                                    </div>
                                                    <div class="pl-5 mt-2 reasoning-content" style="height: auto; transition: height 0.3s">
                                                        <div class="whitespace-pre-wrap text-slate-400"></div>
                                                    </div>
                                                </div>`;
                                        }
                                        
                                        // æ·»åŠ å†…å®¹
                                        const reasoningContent = reasoningElement.querySelector('.reasoning-content');
                                        const reasoningDiv = reasoningContent.querySelector('div');
                                        const text = data.content;
                                        // ç´¯ç§¯æ¨ç†å†…å®¹
                                        if (!window.currentReasoning) window.currentReasoning = '';
                                        window.currentReasoning += text;
                                        // ä¿å­˜åŸå§‹å†…å®¹
                                        reasoningDiv.dataset.originalContent = window.currentReasoning;
                                        // åº”ç”¨ markdown è§£æ
                                        reasoningDiv.innerHTML = parseMarkdown(window.currentReasoning);
                                    } else if (data.type === 'content') {
                                        // å¦‚æœæ˜¯<think>ä¸”æ²¡æœ‰æ€è€ƒå®¹å™¨,åˆ›å»ºä¸€ä¸ª
                                        if (data.content === '<think>' && !reasoningElement.querySelector('.reasoning-content')) {
                                            reasoningElement.innerHTML = `
                                                <div class="text-slate-400">
                                                    <div class="flex items-center cursor-pointer hover:text-slate-300 transition-colors duration-200" onclick="toggleReasoning(this)">
                                                        <svg class="w-4 h-4 mr-1 reasoning-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="transform: rotate(90deg)">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                                        </svg>
                                                        <span class="thinking-label">æ€è€ƒè¿‡ç¨‹</span>
                                                    </div>
                                                    <div class="pl-5 mt-2 reasoning-content" style="height: auto; transition: height 0.3s">
                                                        <div class="whitespace-pre-wrap text-slate-400"></div>
                                                    </div>
                                                </div>`;
                                            window.isThinking = true;
                                        }
                                        // å¦‚æœæ˜¯</think>,æ”¶èµ·æ€è€ƒè¿‡ç¨‹
                                        else if (data.content === '</think>') {
                                            window.isThinking = false;
                                        }
                                        // å¦‚æœåœ¨æ€è€ƒè¿‡ç¨‹ä¸­,å†…å®¹æ·»åŠ åˆ°æ€è€ƒè¿‡ç¨‹ä¸­
                                        else if (window.isThinking && reasoningElement.querySelector('.reasoning-content')) {
                                            const reasoningContent = reasoningElement.querySelector('.reasoning-content');
                                            const reasoningDiv = reasoningContent.querySelector('div');
                                            const text = data.content;
                                            // ç´¯ç§¯æ¨ç†å†…å®¹
                                            if (!window.currentReasoning) window.currentReasoning = '';
                                            window.currentReasoning += text;
                                            // åº”ç”¨ markdown è§£æ
                                            reasoningDiv.innerHTML = parseMarkdown(window.currentReasoning);
                                        }
                                        // å…¶ä»–æƒ…å†µ,æ˜¾ç¤ºåœ¨å“åº”åŒºåŸŸ
                                        else {
                                            // åœæ­¢æ€è€ƒæ ‡ç­¾çš„åŠ¨ç”»
                                            const thinkingLabel = reasoningElement.querySelector('.thinking-label');
                                            if (thinkingLabel) {
                                                thinkingLabel.classList.add('thinking-done');
                                            }
                                            // ç›´æ¥æ·»åŠ å†…å®¹,ä¸åšmarkdownè§£æ
                                            if (window.currentResponse === undefined) {
                                                window.currentResponse = '';
                                            }
                                            // æ”¶åˆ°å†…å®¹æ—¶å°±ç›´æ¥å°†è¿ç»­æ¢è¡Œç¬¦æ›¿æ¢ä¸ºå•ä¸ªæ¢è¡Œç¬¦
                                            const content = data.content.replace(/\n\n/g, '\n');
                                            window.currentResponse += content;
                                            
                                            // ä¿å­˜åŸå§‹å†…å®¹
                                            responseElement.dataset.originalContent = window.currentResponse;
                                            
                                            // å°è¯•è§£ææ•´ä¸ªå†…å®¹çš„markdown
                                            try {
                                                responseElement.innerHTML = parseMarkdown(window.currentResponse);
                                                // ä¿å­˜åŸå§‹å†…å®¹
                                                responseElement.dataset.originalContent = window.currentResponse;
                                            } catch (e) {
                                                // å¦‚æœè§£æå¤±è´¥,è‡³å°‘æ˜¾ç¤ºåŸå§‹å†…å®¹
                                                responseElement.textContent = window.currentResponse;
                                            }
                                        }
                                    }
                                } catch (e) {
                                    console.error('è§£æå“åº”å¤±è´¥:', e);
                                }
                            }
                        }
                    }
                } else {
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            model_type: modelType,
                            api_key: apiKey,
                            model: model,
                            prompt: prompt,
                            enable_streaming: false,
                            include_reasoning: true,
                            context: context
                        })
                    });

                    const data = await response.json();
                    const responseElement = aiMessage.querySelector('pre');
                    const reasoningElement = aiMessage.querySelector('div[id^="ai-reasoning"]');
                    
                    if (data.success) {
                        responseElement.textContent = data.response;
                        if (data.reasoning) {
                            responseElement.innerHTML = parseMarkdown(data.response);
                            reasoningElement.innerHTML = `
                                <div class="text-slate-400">
                                    <div class="flex items-center cursor-pointer hover:text-slate-300 transition-colors duration-200" onclick="toggleReasoning(this)">
                                        <svg class="w-4 h-4 mr-1 reasoning-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="transform: rotate(0deg)">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                        </svg>
                                        æ€è€ƒè¿‡ç¨‹
                                    </div>
                                    <div class="pl-5 mt-2 reasoning-content" style="height: 0">
                                        <pre class="whitespace-pre-wrap">${data.reasoning}</pre>
                                    </div>
                                </div>`;
                        } else {
                            reasoningElement.remove();
                        }
                        // åœ¨æˆåŠŸæ—¶ä¿å­˜èŠå¤©è®°å½•
                        saveChatHistory();
                    } else {
                        responseElement.textContent = 'é”™è¯¯: ' + data.error;
                        responseElement.classList.add('text-red-500');
                        reasoningElement.remove();
                    }
                }
            } catch (error) {
                // ç§»é™¤å‘¼å¸ç¯æ•ˆæœ
                document.querySelector('button[type="submit"]').classList.remove('breathing-button');
                const responseElement = aiMessage.querySelector('pre');
                responseElement.textContent = 'è¯·æ±‚å¤±è´¥: ' + error.message;
                responseElement.classList.add('text-red-500');
            }
        }

        // ç›‘å¬å›è½¦é”®å‘é€æ¶ˆæ¯
        document.getElementById('prompt').addEventListener('keydown', function(e) {
            // å¦‚æœæ­£åœ¨ä½¿ç”¨è¾“å…¥æ³•ï¼ˆIMEï¼‰ï¼Œä¸å¤„ç†å›è½¦äº‹ä»¶
            if (e.isComposing || e.keyCode === 229) {
                return;
            }
            
            // å¦‚æœæŒ‰ä¸‹çš„æ˜¯å›è½¦é”®ï¼Œä½†åŒæ—¶æŒ‰ç€ Shift é”®ï¼Œåˆ™å…è®¸æ¢è¡Œ
            if (e.key === 'Enter' && e.shiftKey) {
                return;
            }
            
            // å¦‚æœæŒ‰ä¸‹çš„æ˜¯å›è½¦é”®
            if (e.key === 'Enter') {
                // é˜»æ­¢é»˜è®¤çš„æ¢è¡Œè¡Œä¸º
                e.preventDefault();
                
                // è·å–å½“å‰è¾“å…¥çš„å†…å®¹
                const content = this.value.trim();
                
                // å¦‚æœå†…å®¹ä¸ºç©ºï¼Œæˆ–è€…å†…å®¹åªåŒ…å«æ¢è¡Œç¬¦ï¼Œåˆ™ä¸å‘é€
                if (!content || content.length === 0) {
                    return;
                }
                
                // å¦‚æœæœ€åä¸€æ¬¡æŒ‰é”®åˆ°ç°åœ¨çš„æ—¶é—´å°äº 500msï¼Œåˆ™ä¸å‘é€
                // è¿™å¯ä»¥é˜²æ­¢ç”¨æˆ·åœ¨å¿«é€Ÿè¾“å…¥æ—¶æ„å¤–è§¦å‘å‘é€
                if (this.lastKeyTime && Date.now() - this.lastKeyTime < 500) {
                    return;
                }
                
                // è®°å½•è¿™æ¬¡æŒ‰é”®çš„æ—¶é—´
                this.lastKeyTime = Date.now();
                
                // å‘é€æ¶ˆæ¯
                sendMessage();
            }
        });

        // å¤„ç† API Key å˜åŒ–
        function handleApiKeyChange() {
            const modelType = document.getElementById('modelType').value;
            const apiKey = document.getElementById('apiKey').value;
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            const config = JSON.parse(localStorage.getItem('aiPaletteConfig') || '{}');
            config[`${modelType}_apiKey`] = apiKey;
            localStorage.setItem('aiPaletteConfig', JSON.stringify(config));
            
            // åˆ·æ–°æ¨¡å‹åˆ—è¡¨
            if (modelType === 'ollama' || ['openai', 'dashscope', 'deepseek', 'siliconflow'].includes(modelType)) {
                refreshModels();
            }
        }

        // ä¿®æ”¹æŠ˜å /å±•å¼€åŠŸèƒ½
        function toggleReasoning(element) {
            const content = element.nextElementSibling;
            const arrow = element.querySelector('.reasoning-arrow');
            
            if (content.style.height === '0px' || content.style.height === '0') {
                content.style.height = content.scrollHeight + 'px';
                arrow.style.transform = 'rotate(90deg)';
                // è®¾ç½®ä¸€ä¸ªå»¶æ—¶ï¼Œç­‰è¿‡æ¸¡åŠ¨ç”»å®Œæˆåè®¾ç½®ä¸º auto
                setTimeout(() => {
                    content.style.height = 'auto';
                }, 300);
            } else {
                // å…ˆè®¾ç½®ä¸ºå…·ä½“é«˜åº¦ï¼Œä»¥ä¾¿åŠ¨ç”»
                content.style.height = content.scrollHeight + 'px';
                // å¼ºåˆ¶é‡ç»˜
                content.offsetHeight;
                // ç„¶åè®¾ç½®ä¸º 0
                content.style.height = '0';
                arrow.style.transform = 'rotate(0deg)';
            }
            
            // ä¿å­˜çŠ¶æ€
            saveChatHistory();
        }

        // ä¿®æ”¹é‡æ–°å‘èµ·å¯¹è¯å‡½æ•°
        function reaskQuestion(button) {
            const aiMessage = button.closest('.flex.items-start');
            const userMessage = aiMessage.previousElementSibling;
            const pElement = userMessage.querySelector('p');
            const prompt = pElement.textContent.replace(/<br\s*\/?>/g, '\n');  // è½¬æ¢å›åŸå§‹æ ¼å¼
            
            // æ”¶é›†ä¹‹å‰çš„æ‰€æœ‰å¯¹è¯å†…å®¹
            const messageList = document.getElementById('messageList');
            const context = [];
            const messages = messageList.children;
            
            // éå†åˆ°å½“å‰æ¶ˆæ¯ä¸ºæ­¢çš„æ‰€æœ‰æ¶ˆæ¯
            for (let i = 0; i < messages.length; i++) {
                const message = messages[i];
                // å¦‚æœåˆ°è¾¾å½“å‰ç”¨æˆ·æ¶ˆæ¯ï¼Œå°±åœæ­¢
                if (message === userMessage) {
                    break;
                }
                
                if (message.querySelector('.bg-blue-600')) {  // ç”¨æˆ·æ¶ˆæ¯
                    const pElement = message.querySelector('p');
                    context.push({
                        role: 'user',
                        content: pElement.textContent.replace(/<br\s*\/?>/g, '\n')  // è½¬æ¢å›åŸå§‹æ ¼å¼
                    });
                } else if (message.querySelector('.bg-purple-600')) {  // AI æ¶ˆæ¯
                    const responseElement = message.querySelector('pre');
                    // ä½¿ç”¨ dataset.originalContent è·å–åŸå§‹å†…å®¹ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ textContent
                    const content = responseElement.dataset.originalContent || responseElement.textContent;
                    if (content && content !== '...') {
                        context.push({
                            role: 'assistant',
                            content: content
                        });
                    }
                }
            }
            
            // è®¾ç½®è¾“å…¥æ¡†å†…å®¹
            document.getElementById('prompt').value = prompt;
            
            // ç§»é™¤å½“å‰çš„ AI å›å¤å’Œç”¨æˆ·æ¶ˆæ¯
            aiMessage.remove();
            userMessage.remove();
            
            // æ¸…é™¤ä¹‹å‰çš„æ¨ç†å†…å®¹
            window.currentReasoning = '';
            
            // ä¿å­˜ä¸Šä¸‹æ–‡åˆ°å…¨å±€å˜é‡ï¼Œä¾›sendMessageä½¿ç”¨
            window.reaskContext = context;
            
            sendMessage();
        }
        
        // æ¸…ç©ºå…¨éƒ¨å¯¹è¯
        function clearAllMessages() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºå…¨éƒ¨å¯¹è¯å—ï¼Ÿ')) {
                // æ¸…ç©ºæœ¬åœ°å­˜å‚¨ä¸­çš„èŠå¤©è®°å½•
                localStorage.removeItem('aiPaletteChatHistory');
                // æ¸…ç©ºé¡µé¢å†…å®¹å¹¶æ˜¾ç¤ºæ¨è
                restoreChatHistory();
            }
        }

        // ä¿®æ”¹å¤åˆ¶å“åº”å†…å®¹å‡½æ•°
        function copyResponse(button) {
            const aiMessage = button.closest('.flex.items-start');
            const responseElement = aiMessage.querySelector('pre');
            
            // è·å–åŸå§‹å†…å®¹ï¼ˆmarkdown æ ¼å¼ï¼‰
            const originalContent = responseElement.dataset.originalContent || responseElement.textContent;
            
            // å¤åˆ¶åˆ°å‰ªè´´æ¿
            navigator.clipboard.writeText(originalContent).then(() => {
                // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
                const originalTitle = button.title;
                button.title = 'å¤åˆ¶æˆåŠŸ!';
                setTimeout(() => {
                    button.title = originalTitle;
                }, 1000);
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                button.title = 'å¤åˆ¶å¤±è´¥';
            });
        }

        // ä½¿ç”¨æç¤ºè¯å¹¶ç›´æ¥å‘é€
        function usePromptAndSend(button) {
            document.getElementById('prompt').value = button.textContent.trim();
            // éšè—å»ºè®®æ¡†
            document.getElementById('suggestionBox').style.display = 'none';
            // ç›´æ¥å‘é€æ¶ˆæ¯
            sendMessage();
        }

        // ä¿®æ”¹æ·»åŠ AIæ¶ˆæ¯çš„éƒ¨åˆ†
        function addAIMessage(message) {
            const modelType = document.getElementById('modelType').value;
            const model = document.getElementById('model').value;
            const modelInfo = `${modelType.toUpperCase()} / ${model}`;
            
            const aiMessage = document.createElement('div');
            aiMessage.className = 'flex items-start space-x-3 mb-4';
            aiMessage.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-purple-600 flex items-center justify-center flex-shrink-0 text-white">AI</div>
                <div class="flex-1 dark:bg-slate-800 bg-white rounded-lg p-4 dark:border-slate-700 border-slate-200 border">
                    <div class="text-xs dark:text-slate-400 text-slate-500 mb-2">${modelInfo}</div>
                    <div class="dark:text-slate-400 text-slate-500 text-sm mb-2" id="ai-reasoning-${Date.now()}"></div>
                    <pre class="dark:text-slate-200 text-slate-700 whitespace-pre-wrap" id="ai-response-${Date.now()}">...</pre>
                    <div class="flex justify-end space-x-2 mt-2 dark:text-slate-400 text-slate-500">
                        <button onclick="copyResponse(this)" class="p-1.5 dark:hover:bg-slate-700 hover:bg-slate-100 rounded-lg" title="å¤åˆ¶å†…å®¹">
                            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                            </svg>
                        </button>
                        <button onclick="reaskQuestion(this)" class="p-1.5 dark:hover:bg-slate-700 hover:bg-slate-100 rounded-lg" title="é‡æ–°å‘èµ·å¯¹è¯">
                            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                        </button>
                        <button onclick="deleteMessage(this)" class="p-1.5 dark:hover:bg-slate-700 hover:bg-slate-100 rounded-lg" title="åˆ é™¤è¿™ä¸€è½®å¯¹è¯">
                            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                </div>
            `;
            return aiMessage;
        }

        // åˆ é™¤å½“å‰å¯¹è¯è½®æ¬¡
        function deleteMessage(button) {
            const aiMessage = button.closest('.flex.items-start');
            const userMessage = aiMessage.previousElementSibling;
            if (userMessage && userMessage.querySelector('.bg-blue-600')) {
                userMessage.remove();
            }
            aiMessage.remove();
            
            // æ›´æ–°å­˜å‚¨çš„èŠå¤©è®°å½•
            saveChatHistory();
            
            // å¦‚æœæ²¡æœ‰æ¶ˆæ¯äº†ï¼Œæ˜¾ç¤ºæ¨è
            const messageList = document.getElementById('messageList');
            if (messageList.children.length === 0) {
                restoreChatHistory();
            }
        }

        // æ·»åŠ ä¸»é¢˜åˆ‡æ¢å‡½æ•°
        function toggleTheme(theme) {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            updateThemeButtons(theme);
            
            // ä¿å­˜ä¸»é¢˜è®¾ç½®
            const config = JSON.parse(localStorage.getItem('aiPaletteConfig') || '{}');
            config.theme = theme;
            localStorage.setItem('aiPaletteConfig', JSON.stringify(config));
        }

        // æ›´æ–°ä¸»é¢˜æŒ‰é’®çŠ¶æ€
        function updateThemeButtons(activeTheme) {
            const darkButton = document.querySelector('.dark-toggle');
            const lightButton = document.querySelector('.light-toggle');
            
            if (activeTheme === 'dark') {
                darkButton.classList.add('bg-blue-600', 'text-slate-50');
                darkButton.classList.remove('dark:text-slate-300', 'text-slate-500');
                lightButton.classList.remove('bg-blue-600', 'text-slate-50');
                lightButton.classList.add('dark:text-slate-300', 'text-slate-500');
            } else {
                lightButton.classList.add('bg-blue-600', 'text-slate-50');
                lightButton.classList.remove('dark:text-slate-300', 'text-slate-500');
                darkButton.classList.remove('bg-blue-600', 'text-slate-50');
                darkButton.classList.add('dark:text-slate-300', 'text-slate-500');
            }
        }

        // ä¿®æ”¹ä¿å­˜èŠå¤©è®°å½•å‡½æ•°
        function saveChatHistory() {
            const messageList = document.getElementById('messageList');
            const messages = [];
            
            for (const message of messageList.children) {
                if (message.id === 'suggestionBox') continue;
                
                if (message.querySelector('.bg-blue-600')) { // ç”¨æˆ·æ¶ˆæ¯
                    const pElement = message.querySelector('p');
                    // å°† <br/> è½¬æ¢å› \n
                    const content = pElement.innerHTML.replace(/<br\s*\/?>/g, '\n');
                    messages.push({
                        type: 'user',
                        content: content
                    });
                } else if (message.querySelector('.bg-purple-600')) { // AI æ¶ˆæ¯
                    const modelInfo = message.querySelector('.text-xs').textContent;
                    const responseElement = message.querySelector('pre');
                    const reasoningElement = message.querySelector('div[id^="ai-reasoning"]');
                    
                    const messageData = {
                        type: 'ai',
                        modelInfo: modelInfo,
                        content: responseElement.dataset.originalContent || responseElement.textContent
                    };

                    // å¦‚æœæœ‰æ¨ç†å†…å®¹ï¼Œä¹Ÿä¿å­˜
                    const reasoningContent = reasoningElement?.querySelector('.reasoning-content');
                    if (reasoningContent) {
                        const reasoningDiv = reasoningContent.querySelector('div');
                        messageData.reasoning = reasoningDiv.dataset.originalContent || reasoningDiv.textContent;
                        // ä¿å­˜å±•å¼€/æŠ˜å çŠ¶æ€
                        messageData.reasoningExpanded = reasoningContent.style.height !== '0px' && reasoningContent.style.height !== '0';
                    }

                    messages.push(messageData);
                }
            }
            
            localStorage.setItem('aiPaletteChatHistory', JSON.stringify(messages));
        }

        // æ·»åŠ æ¢å¤èŠå¤©è®°å½•çš„å‡½æ•°
        function restoreChatHistory() {
            const messageList = document.getElementById('messageList');
            const savedMessages = localStorage.getItem('aiPaletteChatHistory');
            
            if (!savedMessages) {
                // å¦‚æœæ²¡æœ‰èŠå¤©è®°å½•ï¼Œç¡®ä¿æ˜¾ç¤ºå»ºè®®æ¡†
                if (!document.getElementById('suggestionBox')) {
                    messageList.innerHTML = `
                        <div id="suggestionBox" class="mb-4">
                            <div class="flex flex-wrap gap-2 text-xs">
                                <button onclick="usePromptAndSend(this)" class="rounded-lg dark:bg-slate-800 bg-white px-3 py-1.5 dark:hover:bg-blue-600 hover:bg-blue-50 dark:hover:text-slate-200 hover:text-blue-600 dark:text-slate-300 text-slate-600 dark:border-slate-700 border-slate-200 border">
                                    å¸®æˆ‘åˆ¶å®šä¸€ä»½ä¸€å‘¨å¥åº·é¥®é£Ÿè®¡åˆ’
                                </button>
                                <button onclick="usePromptAndSend(this)" class="rounded-lg dark:bg-slate-800 bg-white px-3 py-1.5 dark:hover:bg-blue-600 hover:bg-blue-50 dark:hover:text-slate-200 hover:text-blue-600 dark:text-slate-300 text-slate-600 dark:border-slate-700 border-slate-200 border">
                                    å¦‚ä½•ç¼“è§£å·¥ä½œå‹åŠ›å’Œæƒ…ç»ª
                                </button>
                                <button onclick="usePromptAndSend(this)" class="rounded-lg dark:bg-slate-800 bg-white px-3 py-1.5 dark:hover:bg-blue-600 hover:bg-blue-50 dark:hover:text-slate-200 hover:text-blue-600 dark:text-slate-300 text-slate-600 dark:border-slate-700 border-slate-200 border">
                                    æ¨èä¸€äº›å®¤å†…æ¤ç‰©å…»æŠ¤å°æŠ€å·§
                                </button>
                                <button onclick="usePromptAndSend(this)" class="rounded-lg dark:bg-slate-800 bg-white px-3 py-1.5 dark:hover:bg-blue-600 hover:bg-blue-50 dark:hover:text-slate-200 hover:text-blue-600 dark:text-slate-300 text-slate-600 dark:border-slate-700 border-slate-200 border">
                                    åˆ†äº«ä¸€äº›æé«˜ç¡çœ è´¨é‡çš„æ–¹æ³•
                                </button>
                                <button onclick="usePromptAndSend(this)" class="rounded-lg dark:bg-slate-800 bg-white px-3 py-1.5 dark:hover:bg-blue-600 hover:bg-blue-50 dark:hover:text-slate-200 hover:text-blue-600 dark:text-slate-300 text-slate-600 dark:border-slate-700 border-slate-200 border">
                                    æ¨èå‡ é“ç®€å•ç¾å‘³çš„å®¶å¸¸èœ
                                </button>
                                <button onclick="usePromptAndSend(this)" class="rounded-lg dark:bg-slate-800 bg-white px-3 py-1.5 dark:hover:bg-blue-600 hover:bg-blue-50 dark:hover:text-slate-200 hover:text-blue-600 dark:text-slate-300 text-slate-600 dark:border-slate-700 border-slate-200 border">
                                    å¦‚ä½•æ•´ç†å’Œæ”¶çº³å°æˆ·å‹ç©ºé—´
                                </button>
                                <button onclick="usePromptAndSend(this)" class="rounded-lg dark:bg-slate-800 bg-white px-3 py-1.5 dark:hover:bg-blue-600 hover:bg-blue-50 dark:hover:text-slate-200 hover:text-blue-600 dark:text-slate-300 text-slate-600 dark:border-slate-700 border-slate-200 border">
                                    åˆ†äº«ä¸€äº›çœé’±å°å¦™æ‹›
                                </button>
                            </div>
                        </div>`;
                }
                return;
            }

            const messages = JSON.parse(savedMessages);
            messageList.innerHTML = ''; // æ¸…ç©ºç°æœ‰å†…å®¹
            
            for (const message of messages) {
                if (message.type === 'user') {
                    const userMessage = document.createElement('div');
                    userMessage.className = 'flex items-start space-x-3 mb-4';
                    // å°†åŸå§‹å†…å®¹ä¸­çš„ \n è½¬æ¢ä¸º <br/>
                    const displayContent = message.content.replace(/\n/g, '<br/>');
                    userMessage.innerHTML = `
                        <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center flex-shrink-0 text-white">U</div>
                        <div class="flex-1 dark:bg-slate-800 bg-white rounded-lg p-4 dark:border-slate-700 border-slate-200 border">
                            <p class="dark:text-slate-200 text-slate-700">${displayContent}</p>
                        </div>
                    `;
                    messageList.appendChild(userMessage);
                } else if (message.type === 'ai') {
                    const aiMessage = document.createElement('div');
                    aiMessage.className = 'flex items-start space-x-3 mb-4';
                    
                    let reasoningHtml = '';
                    if (message.reasoning) {
                        const arrowRotation = message.reasoningExpanded ? 'rotate(90deg)' : 'rotate(0deg)';
                        const contentHeight = message.reasoningExpanded ? 'auto' : '0';
                        reasoningHtml = `
                            <div class="text-slate-400">
                                <div class="flex items-center cursor-pointer hover:text-slate-300 transition-colors duration-200" onclick="toggleReasoning(this)">
                                    <svg class="w-4 h-4 mr-1 reasoning-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="transform: ${arrowRotation}">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                    </svg>
                                    æ€è€ƒè¿‡ç¨‹
                                </div>
                                <div class="pl-5 mt-2 reasoning-content" style="height: ${contentHeight}; transition: height 0.3s">
                                    <div class="whitespace-pre-wrap text-slate-400" data-original-content="${escapeHtml(message.reasoning)}">${parseMarkdown(message.reasoning)}</div>
                                </div>
                            </div>`;
                    }

                    aiMessage.innerHTML = `
                        <div class="w-8 h-8 rounded-full bg-purple-600 flex items-center justify-center flex-shrink-0 text-white">AI</div>
                        <div class="flex-1 dark:bg-slate-800 bg-white rounded-lg p-4 dark:border-slate-700 border-slate-200 border">
                            <div class="text-xs dark:text-slate-400 text-slate-500 mb-2">${message.modelInfo}</div>
                            <div class="dark:text-slate-400 text-slate-500 text-sm mb-2" id="ai-reasoning-${Date.now()}">${reasoningHtml}</div>
                            <pre class="dark:text-slate-200 text-slate-700 whitespace-pre-wrap" data-original-content="${escapeHtml(message.content)}">${parseMarkdown(message.content)}</pre>
                            <div class="flex justify-end space-x-2 mt-2 dark:text-slate-400 text-slate-500">
                                <button onclick="copyResponse(this)" class="p-1.5 dark:hover:bg-slate-700 hover:bg-slate-100 rounded-lg" title="å¤åˆ¶å†…å®¹">
                                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                    </svg>
                                </button>
                                <button onclick="reaskQuestion(this)" class="p-1.5 dark:hover:bg-slate-700 hover:bg-slate-100 rounded-lg" title="é‡æ–°å‘èµ·å¯¹è¯">
                                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                    </svg>
                                </button>
                                <button onclick="deleteMessage(this)" class="p-1.5 dark:hover:bg-slate-700 hover:bg-slate-100 rounded-lg" title="åˆ é™¤è¿™ä¸€è½®å¯¹è¯">
                                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `;
                    messageList.appendChild(aiMessage);
                }
            }
        }
    </script>
</body>
</html> 